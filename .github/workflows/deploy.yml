name: "Build and Release"

on:
  push:
    paths:
      - 'C.H.E.S.S/CHANGELOGS.md'

env:
  GODOT_VERSION: "4.5"
  ITCH_USER: "K4-KC"
  ITCH_GAME: "chess"

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [windows, linux, macos]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true # For large assets

      # ---------------------------------------------------------
      # STEP 0: Smart Changelog Parser
      # ---------------------------------------------------------
      - name: Parse Changelog
        id: parse_data
        shell: bash
        run: |
          # ðŸ” DEBUGGING START: Show me the file structure
          echo "Listing all files in the repository:"
          ls -R
          echo "--------------------------------------"
          # ðŸ” DEBUGGING END

          FILE="C.H.E.S.S/CHANGELOGS.md"
          
          # 1. Grab the first header line (e.g., "## v0.1.5")
          RAW_HEADER=$(grep -m 1 "^## " "$FILE")
          # Remove '## ' and whitespace
          TAG_NAME=$(echo "$RAW_HEADER" | sed 's/## //g' | xargs)
          # Remove 'v' for Itch.io versioning
          CLEAN_VERSION=${TAG_NAME#v}
          
          echo "Found Version: $TAG_NAME"
          
          # 2. Extract the Body (Text between first ## and the next ##)
          BODY=$(awk '/^## / { if (p) { exit }; p=1; next } p' "$FILE")
          
          # 3. Check for Pre-release (Look for a hyphen, e.g., "v0.1.5-beta")
          if [[ "$TAG_NAME" == *"-"* ]]; then
            echo "Detected Pre-release: YES"
            IS_PRE="true"
          else
            echo "Detected Pre-release: NO"
            IS_PRE="false"
          fi

          # 4. Export to GitHub Outputs
          echo "VERSION=$CLEAN_VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "PRERELEASE=$IS_PRE" >> $GITHUB_OUTPUT
          
          # Multiline string export for the Body
          echo "BODY<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # STEP 1: Manual Import with "Crash Protection"
      # ---------------------------------------------------------
      - name: Setup and Import Godot (Ignore Crash)
        shell: bash
        run: |
          # 1. Download Godot 4.5
          wget -q https://github.com/godotengine/godot/releases/download/${{ env.GODOT_VERSION }}-stable/Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64.zip
          unzip -q Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64.zip
          mv Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64 godot
          chmod +x godot

          # 2. Run Import with Timeout (and ignore exit code 11)
          echo "Starting Import..."
          timeout 1m ./godot --headless --path ./C.H.E.S.S --editor --quit || true
          
          # 3. Verify Success
          if [ -d "./C.H.E.S.S/.godot" ]; then
              echo "âœ… .godot folder exists. Import was successful."
          else
              echo "âŒ .godot folder missing. Import failed."
              exit 1
          fi

      # ---------------------------------------------------------
      # STEP 2: Export
      # ---------------------------------------------------------
      - name: Godot Export
        uses: firebelley/godot-export@v5.2.1
        with:
          godot_executable_download_url: "https://github.com/godotengine/godot/releases/download/${{ env.GODOT_VERSION }}-stable/Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64.zip"
          godot_export_templates_download_url: "https://github.com/godotengine/godot/releases/download/${{ env.GODOT_VERSION }}-stable/Godot_v${{ env.GODOT_VERSION }}-stable_export_templates.tpz"
          relative_project_path: "./C.H.E.S.S" 
          archive_output: true
          export_preset: ${{ matrix.platform }}
          use_preset_export_path: true
          cache: false
          additional_args: "--headless"

      # ---------------------------------------------------------
      # STEP 3: Find the Zip File (Handles long names + spaces)
      # ---------------------------------------------------------
      - name: Find Exported Zip
        id: find_zip
        shell: bash
        run: |
          # Find the only .zip file in the exports folder
          # We use 'find' to handle spaces in filenames correctly
          ZIP_PATH=$(find C.H.E.S.S/exports -name "*.zip" -type f | head -n 1)
          
          if [ -z "$ZIP_PATH" ]; then
            echo "âŒ No zip file found in C.H.E.S.S/exports!"
            exit 1
          fi

          echo "Found package: $ZIP_PATH"
          # Save the path to an environment variable for the next step
          echo "GAME_PACKAGE_PATH=$ZIP_PATH" >> $GITHUB_ENV

      # ---------------------------------------------------------
      # STEP 4: Publish to Itch.io
      # ---------------------------------------------------------
      - name: Publish to Itch.io
        uses: yeslayla/butler-publish-itchio-action@master
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_API_KEY }}
          CHANNEL: ${{ matrix.platform }}
          ITCH_GAME: ${{ env.ITCH_GAME }}
          ITCH_USER: ${{ env.ITCH_USER }}
          # Use the variable we found in the previous step
          PACKAGE: ${{ env.GAME_PACKAGE_PATH }}
          VERSION: ${{ steps.parse_data.outputs.VERSION }}
      
      # ---------------------------------------------------------
      # STEP 5: Create GitHub Release
      # ---------------------------------------------------------

      - name: GitHub Release
        uses: softprops/action-gh-release@v2
        if: matrix.platform == 'windows' 
        with:
          tag_name: ${{ steps.parse_data.outputs.TAG }}
          name: C.H.E.S.S. - Competitive Hybrid Engine Strategy Simulator ${{ steps.parse_data.outputs.TAG }}
          body: ${{ steps.parse_data.outputs.BODY }}
          prerelease: ${{ steps.parse_data.outputs.PRERELEASE }}
          files: C.H.E.S.S/exports/*.zip